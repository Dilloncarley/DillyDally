

<dom-module id="video-camera">
<template>
    <style>
        :host {
        }

        #videoId{
            width:100%;
        }

        #videoId[is-pip]{
            transform-origin: top left;
            transform: scale(0.2,0.2);
            position: absolute;
            transition: transform 0.3s;
        }
        #videoId[is-closed]{
            display: none;
        }
    </style>
    <video id="videoId" on-tap="snap"></video>
    <canvas id="canvas" style="display:none"></canvas>
</template>
<script>
Polymer({
    is: "video-camera",
    properties: {
        screenshot: {
            type: String,
            notify: true
        },
        videoelement: {
            type: Object,
            notify: true
        },
        stream: {
            type: Object,
            notify: true
            // observer: '_stream_changed'           
        }
    //     waitforinput: {
    //         type: Boolean,
    //         value: false,
    //         observer: '_wfi_changed'
    //     }
    },
    startCamera: function(open,camera){
        // Grab elements, create settings, etc.
        var canvas = this.$.canvas;

        var video = this.$.videoId;

        this.videoelement = video;


        var context = canvas.getContext("2d"),
       
        errBack = function(error) {
            console.log("Video capture error: ", error.code); 
        };

        // Put video listeners into place
        var me=this;

navigator.getMedia = ( navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);


        if(!this.waitforinput){
                if (open == "initalDisable"){


                    
                   }
                else{
//                      navigator.mediaDevices.enumerateDevices()
//   .then(gotDevices)
//   .catch();

                    function gotDevices(deviceInfos) {

  
                                var frontCameraId = "";
                                  for (var i = 0; i !== deviceInfos.length; ++i) {
                                    var deviceInfo = deviceInfos[i];
                                    var option = document.createElement('option');
                                    option.value = deviceInfo.deviceId;
                                    
                                    if (deviceInfo.kind === 'videoinput') {
                                      option.text = deviceInfo.label || 'Camera ' +
                                        (videoSelect.length + 1);
                                        frontCameraId += deviceInfos[1].deviceId
                                        
                                    }



                                }
                                  return frontCameraId;
                                                }
        
                          navigator.mediaDevices.enumerateDevices().then(function(result) {
                             videoObj = {video: {

 
      facingMode:camera
      // sourceId: result
    
  }}
                        navigator.getMedia(videoObj, function(stream){
                    me.set('videoelement.src', window.URL.createObjectURL(stream));
                    me.set('stream', stream);
                    
                    console.log(me.stream.getVideoTracks()[0])

  
                     // video.setSinkId('default').then(() => video.setSinkId("dogs"))
                         video.play();
                    
                   
                       
                        
                   
                    //      
     
                    // }
                   
                }, errBack); 
})   
                    
                }
                
               
               
            /*if(navigator.getUserMedia) { // Standard
                navigator.getUserMedia(videoObj, function(stream) {
                    me.set('videoelement.src', stream);
                    video.play();
                }, errBack);
            } else if(navigator.webkitGetUserMedia) { // WebKit-prefixed
                navigator.webkitGetUserMedia(videoObj, function(stream){
                    me.set('videoelement.src', window.URL.createObjectURL(stream));
                    me.set('stream', stream);
                    //video.src=window.URL.createObjectURL(stream);
                    video.play();
                }, errBack);
            }
            else if(navigator.mozGetUserMedia) { // Firefox-prefixed
                navigator.mozGetUserMedia(videoObj, function(stream){
                    me.set('videoelement.src', window.URL.createObjectURL(stream));
                    me.set('stream', stream);
                    video.play();
                }, errBack);
            }*/
        }
         
    },
    _wfi_changed: function(){
        if(this.waitforinput)
            this.$.videoId.setAttribute('is-closed', true);
    },
    _stream_changed: function(){
        if(this.stream){
            this.$.videoId.removeAttribute('is-closed');
            if(this.waitforinput){
                this.set('videoelement.src', window.URL.createObjectURL(this.stream));
                this.$.videoId.play();
                /*if(navigator.getUserMedia) { 
                    this.set('videoelement.src', this.stream);
                }else{
                    this.set('videoelement.src', window.URL.createObjectURL(this.stream));
                }*/
            }
        }else{
            this.$.videoId.setAttribute('is-closed', true);

        }
    },
    snap: function(){
        this.takePicture(true);
    },
    hide: function(){
        this.$.videoId.setAttribute('is-closed', true);
    },
    toggleCamera: function(){
        console.log( this.stream.getVideoTracks()[0])
        for(i = 0; i < this.stream.getVideoTracks().length; i++){
            this.stream.getVideoTracks()[i].stop();
            this.stream.getVideoTracks()[i].enabled = false;
            console.log( this.stream.getVideoTracks()[i])
        }
    

    },
    pip: function(){
        if (this.$.videoId.hasAttribute('is-pip')) {
            this.$.videoId.removeAttribute('is-pip');
        }else{
            this.$.videoId.setAttribute('is-pip', true);
        }
    },
    takePicture: function(actually){
        if(actually){
            var canvas = this.$.canvas;
            var videoObj = this.$.videoId;

            var context = canvas.getContext('2d');

            videoObj.setAttribute('width', videoObj.clientWidth);
            videoObj.setAttribute('height', videoObj.clientHeight);

            canvas.width = videoObj.clientWidth;
            canvas.height = videoObj.clientHeight;
            
            context.drawImage(videoObj, 0, 0, canvas.width, canvas.height);

            this.screenshot = canvas.toDataURL('image/png');   
        }  
    },
   
});
</script>


<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</dom-module>